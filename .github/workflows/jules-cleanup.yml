# SAFE VERSION - Jules Cleanup (Weekly, Manual Approval Required)
#
# This is a SAFE version of Jules cleanup that:
# - Runs weekly instead of every 30 minutes
# - Creates PR for review (no auto-merge)
# - Requires human approval before merge
# - Respects CI/CD checks
#
# To activate: Rename to jules-cleanup.yml

name: Jules Code Cleanup (Safe Mode)

on:
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Can create branches and PRs
  pull-requests: write  # Can create PRs

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # IMPORTANT: Verify this action exists before using!
      # As of 2025-11-22, BeksOmega/jules-action@v1 returns 404
      # Check: https://github.com/BeksOmega/jules-action
      - name: Invoke Jules for Cleanup Analysis
        uses: BeksOmega/jules-action@v1
        with:
          prompt: |
            Analyze the C# codebase for code quality improvements:

            **Focus Areas:**
            1. Dead code removal
               - Unused methods and properties
               - Unused using directives
               - Unreachable code blocks

            2. Code duplication
               - Repeated logic that could be extracted
               - Similar patterns across files

            3. Complexity reduction
               - Functions with high cyclomatic complexity
               - Deeply nested conditionals
               - Long method refactoring

            4. Naming conventions
               - Inconsistent naming
               - Non-descriptive names
               - C# naming convention violations

            **Guidelines:**
            - Be conservative - only suggest clear improvements
            - Maintain existing functionality
            - Do not change public APIs
            - Follow C# and .NET best practices
            - Preserve existing tests

            **Constraints:**
            - Do NOT change configuration files
            - Do NOT modify CI/CD workflows
            - Do NOT alter documentation
            - Focus only on src/ and tests/ directories

          jules_api_key: ${{ secrets.JULES_API_KEY }}

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "refactor: Automated cleanup suggestions by Jules AI"
          title: "ü§ñ Automated Code Cleanup by Jules"
          body: |
            ## Summary

            Jules AI has analyzed the codebase and identified potential improvements:

            - Dead code removal
            - Duplication reduction
            - Complexity simplification
            - Naming convention fixes

            ## Review Checklist

            Please verify:
            - [ ] All tests pass
            - [ ] No breaking changes to public APIs
            - [ ] Changes make code more maintainable
            - [ ] No unintended functionality changes

            ## CI/CD Status

            This PR requires:
            - ‚úÖ All CI checks passing
            - ‚úÖ 2 reviewer approvals
            - ‚úÖ Manual merge (no auto-merge)

            ---

            *Generated by Jules AI Cleanup - Review carefully before merging*

          branch: jules/automated-cleanup-{{ date 'YYYY-MM-DD' }}
          delete-branch: true
          labels: |
            automated
            code-quality
            jules-cleanup

      # NO AUTO-MERGE STEP
      # Human reviewers must:
      # 1. Review the changes
      # 2. Verify CI passes
      # 3. Manually approve and merge

      - name: Post cleanup summary
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.cpr.outputs.pull-request-number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Jules Cleanup Analysis Complete

              ‚úÖ Cleanup PR created successfully.

              **Next Steps:**
              1. Review the proposed changes carefully
              2. Verify all CI checks pass
              3. Request reviews from team members
              4. Manually merge if changes are appropriate

              **This PR will NOT auto-merge.** Human review is required.
              `
            })

      - name: Summary
        if: steps.cpr.outputs.pull-request-operation == 'created'
        run: |
          echo "‚úÖ Jules cleanup PR created: #${{ steps.cpr.outputs.pull-request-number }}"
          echo "üîó URL: ${{ steps.cpr.outputs.pull-request-url }}"
          echo "‚ö†Ô∏è  Manual review and merge required"
