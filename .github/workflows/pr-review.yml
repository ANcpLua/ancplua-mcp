name: PR Review with Gemini

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Automatic review when PR is opened/updated
  auto-review:
    name: Automatic PR Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Review PR with Gemini 3.0 Pro
      uses: truongnh1992/gemini-ai-code-reviewer@v9.1.0
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_MODEL: "gemini-3.0-pro"
        EXCLUDE: "*.md,*.txt,*.json,*.yml,*.yaml,package-lock.json,*.csproj,*.sln"

  # On-demand review triggered by comment
  on-demand-review:
    name: On-Demand PR Review
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/gemini-review')
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get PR branch
      id: pr-info
      run: |
        PR_NUMBER=${{ github.event.issue.number }}
        PR_DATA=$(gh pr view $PR_NUMBER --json headRefName,headRepository)
        HEAD_REF=$(echo $PR_DATA | jq -r '.headRefName')
        echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout PR branch
      run: |
        git fetch origin ${{ steps.pr-info.outputs.head_ref }}
        git checkout ${{ steps.pr-info.outputs.head_ref }}

    - name: Review PR with Gemini 3.0 Pro
      uses: truongnh1992/gemini-ai-code-reviewer@v9.1.0
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_MODEL: "gemini-3.0-pro"
        EXCLUDE: "*.md,*.txt,*.json,*.yml,*.yaml,package-lock.json,*.csproj,*.sln"
