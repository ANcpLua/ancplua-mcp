name: PR Review with Jules AI

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-review:
    name: Automatic PR Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Review PR with Jules
      uses: BeksOmega/jules-action@v1
      with:
        prompt: |
          Review this pull request for:
          - Code quality and best practices
          - Potential bugs or security issues
          - Performance concerns
          - Maintainability and readability
          - Test coverage

          Focus on C# and .NET code. Skip documentation files, configs, and generated files.
          Provide constructive feedback with specific suggestions.
        jules_api_key: ${{ secrets.JULES_API_KEY }}

  on-demand-review:
    name: On-Demand PR Review
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/jules-review')
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Get PR branch
      id: pr-info
      run: |
        PR_NUMBER=${{ github.event.issue.number }}
        PR_DATA=$(gh pr view $PR_NUMBER --json headRefName,headRepository)
        HEAD_REF=$(echo $PR_DATA | jq -r '.headRefName')
        echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout PR branch
      run: |
        git fetch origin ${{ steps.pr-info.outputs.head_ref }}
        git checkout ${{ steps.pr-info.outputs.head_ref }}

    - name: Review PR with Jules
      uses: BeksOmega/jules-action@v1
      with:
        prompt: |
          Review this pull request for:
          - Code quality and best practices
          - Potential bugs or security issues
          - Performance concerns
          - Maintainability and readability
          - Test coverage

          Focus on C# and .NET code. Skip documentation files, configs, and generated files.
          Provide constructive feedback with specific suggestions.
        jules_api_key: ${{ secrets.JULES_API_KEY }}
